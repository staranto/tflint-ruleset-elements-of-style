name: release
run-name: Release ${{ github.ref_name }}

on:
  push:
    branches:
      - "!*"
    tags:
      - v*.*.*

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    name: goreleaser
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.25" # pick appropriate Go version for your project

      - name: Install cosign v3 (cosign with Rekor / bundles support)
        run: |
          set -euo pipefail
          COSIGN_VERSION=v3.0.2
          COSIGN_BIN="/usr/local/bin/cosign"
          echo "Installing cosign ${COSIGN_VERSION}"
          curl -fsSL -o cosign "${GITHUB_SERVER_URL:-https://github.com}/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64"
          sudo install -m 0755 cosign "${COSIGN_BIN}"
          cosign version

      - name: Ensure rekor (optional debug)
        run: |
          echo "Rekor URL: https://rekor.sigstore.dev"
          curl -fsS https://rekor.sigstore.dev/api/v1/log -o /dev/null || echo "rekor reachable check (non-fatal)"

      - name: Run goreleaser
        uses: goreleaser/goreleaser-action@v2
        with:
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Tell cosign where Rekor is (default is https://rekor.sigstore.dev)
          COSIGN_REKOR_URL: "https://rekor.sigstore.dev"
          # (optional) configure cosign to use experimental features if required by your setup
          # COSIGN_EXPERIMENTAL: "1"
